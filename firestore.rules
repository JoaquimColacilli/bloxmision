rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES HELPER
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email == 'admin@bloxmision.com';
    }
    
    function isValidPlayerLevel(level) {
      return level in ['Grumete', 'Marinero', 'Navegante', 'Capitán Junior', 'Capitán Experto'];
    }
    
    function isValidUser(data) {
      return data.keys().hasAll(['uid', 'email', 'displayName', 'createdAt', 
                                  'currentWorld', 'currentLevel', 'totalXP', 
                                  'playerLevel', 'streak', 'badges', 'settings'])
        && data.uid == request.auth.uid
        && data.totalXP >= 0
        && data.totalXP <= 100000
        && data.currentWorld >= 1 && data.currentWorld <= 10
        && data.currentLevel >= 1 && data.currentLevel <= 50
        && isValidPlayerLevel(data.playerLevel);
    }
    
    function isValidProgress(data) {
      return data.keys().hasAll(['userId', 'levelId', 'worldId', 'completed', 'attempts', 
                                  'usedHints', 'blockCount', 'isOptimal', 'stars', 
                                  'xpEarned', 'completedAt', 'isFirstCompletion'])
        && data.userId == request.auth.uid
        && data.completed == true
        && data.attempts >= 1 && data.attempts <= 1000
        && data.usedHints >= 0
        && data.xpEarned >= 0 && data.xpEarned <= 200
        && data.stars >= 1 && data.stars <= 3
        && data.blockCount >= 1 && data.blockCount <= 100
        && data.levelId is string
        && data.worldId is string;
    }
    
    // ============================================
    // USERS COLLECTION
    // Solo el dueño puede leer/escribir su documento
    // XP solo puede aumentar (anti-cheating)
    // ============================================
    
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      
      // CREATE: Solo documento propio con datos iniciales válidos
      allow create: if isOwner(userId)
        && request.resource.data.uid == userId
        && request.resource.data.totalXP == 0
        && request.resource.data.currentWorld == 1
        && request.resource.data.currentLevel == 1
        && request.resource.data.playerLevel == 'Grumete';
      
      // UPDATE: Documento propio con límites razonables
      // XP solo puede aumentar (no rollback/cheating)
      allow update: if isOwner(userId)
        && isValidUser(request.resource.data)
        && request.resource.data.uid == resource.data.uid  // No cambiar UID
        && request.resource.data.totalXP >= resource.data.totalXP;  // XP solo aumenta
      
      // DELETE: Nunca permitido desde cliente
      allow delete: if false;
    }
    
    // ============================================
    // PROGRESS COLLECTION
    // Inmutable: solo CREATE, no UPDATE/DELETE
    // ============================================
    
    match /progress/{progressId} {
      // READ: Solo registros propios
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // CREATE: Validar campos requeridos y límites
      allow create: if isAuthenticated()
        && isValidProgress(request.resource.data);
      
      // INMUTABLE: No updates ni deletes
      allow update, delete: if false;
    }
    
    // ============================================
    // LEVELS COLLECTION
    // Solo lectura para usuarios autenticados
    // ============================================
    
    match /levels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // WORLDS COLLECTION
    // Solo lectura para jugadores
    // ============================================
    
    match /worlds/{worldId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // MAP FRAGMENTS COLLECTION
    // Solo lectura
    // ============================================
    
    match /mapFragments/{fragmentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // BADGES COLLECTION (catálogo)
    // Solo lectura
    // ============================================
    
    match /badges/{badgeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // LEADERBOARD COLLECTION
    // Lectura pública, escritura solo server/admin
    // ============================================
    
    match /leaderboard/{entry} {
      allow read: if true;
      allow write: if false;
    }
  }
}
